#!/bin/bash -e

# TODO: Replace with https://sh.rustup.rs when it supports -y and such
rustup_init_url='https://raw.githubusercontent.com/rust-lang-nursery/rustup.rs/master/rustup-init.sh'

ci-install() {
    local default_target

    if [[ "$TARGET" == *-musl ]]; then sudo apt-get -y install musl-tools; fi
    curl "$rustup_init_url" -sSf | sh -s -- -y --default-toolchain="$TOOLCHAIN"
    default_target="$(rustup target list | grep default | awk '{print $1}')"
    if [[ "$TARGET" != "$default_target" ]]; then rustup target add "$TARGET"; fi
}

ci-test() {
    cargo test
}

ci-deploy() {
    cargo build --release --target="$TARGET"
    mkdir -p "target/deploy/$TARGET"
    cp "target/$TARGET/release/rq" "target/deploy/$TARGET/rq"
}

case "$1" in
    install )
        shift; ci-install "$@" ;;
    test )
        shift; ci-test "$@" ;;
    deploy )
        shift; ci-deploy "$@" ;;
esac
